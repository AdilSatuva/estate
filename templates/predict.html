<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans %}Предсказание цены{% endtrans %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">{% trans %}Предсказать цену квартиры{% endtrans %}</h1>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" class="needs-validation" novalidate>
            {{ form.hidden_tag() }}
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="{{ form.city.id }}" class="form-label">{% trans %}Город{% endtrans %}</label>
                    {{ form.city(class="form-select", required=True) }}
                    <div class="invalid-feedback">{% trans %}Выберите город{% endtrans %}</div>
                </div>
                <div class="col-md-6">
                    <label for="{{ form.rooms.id }}" class="form-label">{% trans %}Комнаты{% endtrans %}</label>
                    {{ form.rooms(class="form-select", required=True) }}
                    <div class="invalid-feedback">{% trans %}Выберите количество комнат{% endtrans %}</div>
                </div>
                <div class="col-md-6">
                    <label for="{{ form.floor.id }}" class="form-label">{% trans %}Этаж{% endtrans %}</label>
                    {{ form.floor(class="form-control", type="number", min=1, max=20, required=True, **{'data-bs-toggle': 'tooltip', 'title': 'Этаж от 1 до 20'}) }}
                    <div class="invalid-feedback">{% trans %}Укажите этаж (1-20){% endtrans %}</div>
                </div>
                <div class="col-md-6">
                    <label for="{{ form.area.id }}" class="form-label">{% trans %}Площадь (м²){% endtrans %}</label>
                    {{ form.area(class="form-control", type="number", step="0.1", min=10, max=500, required=True, **{'data-bs-toggle': 'tooltip', 'title': 'Площадь от 10 до 500 м²'}) }}
                    <div class="invalid-feedback">{% trans %}Укажите площадь (10-500 м²){% endtrans %}</div>
                </div>
                <div class="col-md-6">
                    <label for="{{ form.total_floors.id }}" class="form-label">{% trans %}Всего этажей{% endtrans %}</label>
                    {{ form.total_floors(class="form-control", type="number", min=1, max=50, required=True, **{'data-bs-toggle': 'tooltip', 'title': 'Этажей в здании от 1 до 50'}) }}
                    <div class="invalid-feedback">{% trans %}Укажите количество этажей (1-50){% endtrans %}</div>
                </div>
                <div class="col-md-6">
                    <label for="{{ form.amenities.id }}" class="form-label">{% trans %}Удобства{% endtrans %}</label>
                    {{ form.amenities(class="form-select", multiple=True, size=6) }}
                    <small class="form-text text-muted">{% trans %}Выберите несколько удобств, удерживая Ctrl{% endtrans %}</small>
                </div>
                <div class="col-12">
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </div>
        </form>

        {% if prediction %}
            <div class="card mt-5">
                <div class="card-header">
                    <h3>{% trans %}Результат предсказания{% endtrans %}</h3>
                </div>
                <div class="card-body">
                    <p><strong>{% trans %}Город{% endtrans %}:</strong> {{ prediction.city }}</p>
                    <p><strong>{% trans %}Комнаты{% endtrans %}:</strong> {{ prediction.rooms }}</p>
                    <p><strong>{% trans %}Этаж{% endtrans %}:</strong> {{ prediction.floor }}</p>
                    <p><strong>{% trans %}Площадь{% endtrans %}:</strong> {{ prediction.area }} м²</p>
                    <p><strong>{% trans %}Всего этажей{% endtrans %}:</strong> {{ prediction.total_floors }}</p>
                    <p><strong>{% trans %}Удобства{% endtrans %}:</strong> {{ prediction.amenities|join(', ') or 'Нет' }}</p>
                    <p><strong>{% trans %}Предсказанная цена{% endtrans %}:</strong> ${{ prediction.price|format_price }} USD</p>
                </div>
            </div>
        {% endif %}

        {% if comparables %}
            <h3 class="mt-5">{% trans %}Сравнимые квартиры{% endtrans %}</h3>
            <div class="row row-cols-1 row-cols-md-3 g-4">
                {% for comp in comparables %}
                    <div class="col">
                        <div class="card h-100">
                            <img src="{{ comp.image }}" class="card-img-top" alt="{% trans %}Квартира{% endtrans %}" style="height: 200px; object-fit: cover;">
                            <div class="card-body">
                                <h5 class="card-title">{{ comp.city }} - {{ comp.rooms }} {% trans %}комнат{% endtrans %}</h5>
                                <p class="card-text">
                                    <strong>{% trans %}Площадь{% endtrans %}:</strong> {{ comp.area }} м²<br>
                                    <strong>{% trans %}Этаж{% endtrans %}:</strong> {{ comp.floor }} / {{ comp.total_floors }}<br>
                                    <strong>{% trans %}Цена{% endtrans %}:</strong> ${{ comp.price|format_price }} USD<br>
                                    <strong>{% trans %}Удобства{% endtrans %}:</strong> {{ comp.amenities|join(', ') or 'Нет' }}
                                </p>
                                <a href="{{ url_for('details', apartment_id=comp.id) }}" class="btn btn-outline-primary">{% trans %}Подробнее{% endtrans %}</a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Enable Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // Form validation
        (function () {
            'use strict'
            var forms = document.querySelectorAll('.needs-validation')
            Array.prototype.slice.call(forms).forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    form.classList.add('was-validated')
                }, false)
            })
        })()
    </script>
</body>
</html>